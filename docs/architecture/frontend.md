# Архитектура фронтенда QuickEstimate Builder

## Общий подход
- **Стек**: TypeScript + React 18 + Vite. React выбран за развитую экосистему и поддержку мобильных паттернов, Vite — за быструю разработку и готовые PWA-плагины.
- **SPA + PWA**: единый бандл, сервис-воркер на базе Workbox, манифест с iOS-специфичными метаданными.
- **Feature-Sliced Design**: код организован по модулям `src/features/<feature>` с локальными состояниями, сервисами и виджетами. Общие библиотеки лежат в `src/shared`.
- **Мобильный-first**: компоненты оптимизированы под портретный режим, используется `window.visualViewport` для корректировки safe areas на iPhone 15.

## Каркас приложения и навигация
- `<AppRoot>` — точка входа; подключает провайдеры (Zustand, React Query, i18n, темизация, маршрутизатор, обработчики ошибок).
- `<AppShell>` — отображает нижнюю таб-бар-навигацию (Dashboard, Estimates, Agents, Reports, Settings) и плавающую панель действий.
- `<ModalHost>` — стек модальных окон (быстрое создание, импорты, история запусков агентов).
- Команда доступа: жесты и клавиатурные сокращения (`⌘K` на десктопе) открывают глобальную командную палитру.
- Маршруты загружаются лениво, каждая вкладка — независимый чанк.

## Страницы и ключевые модули
1. **Dashboard**
   - Виджеты: последние сметы, статусы синхронизации, уведомления об актуализации, прогресс агента.
   - Источники данных: IndexedDB (кэш), фоновые события синхронизации.
2. **Estimate Directory**
   - Возможности: полнотекстовый поиск, фильтры (статус, теги, исполнители), массовые действия (экспорт, архивирование).
   - Компоненты: `<EstimateList>`, `<FilterDrawer>`, `<BulkActionsToolbar>`.
3. **Estimate Workspace**
   - Подразделы: сводка (итоги, KPI), иерархическое дерево позиций, таймлайн изменений, панель советов ИИ.
   - Функции: оптимистичное редактирование, группировка, сравнение версий, быстрые заметки.
4. **Agents Hub**
   - Карточки агентов, мастер настройки, дебаггер флоу, просмотр логов.
   - Поддержка копирования шаблонов, подключения источников (CSV, API поставщиков, исторические каталоги).
5. **Reports & Insights**
   - Диаграммы (строчные/столбчатые, пай), матрица сравнения смет, экспорт PDF/XLSX.
   - Асинхронная генерация: прогресс показывает сервис-воркер; offline — ставит задачу в очередь.
6. **Settings & Support**
   - Профиль, управление подключениями, чистка локального хранилища, советы по установке PWA на iOS, центр онбординга.

## Управление состоянием
- **Zustand** + immer для глобального состояния (легковесный, хорошо работает офлайн). Срезы:
  - `authSlice`: сессия пользователя, ключи шифрования, признаки онбординга.
  - `estimateSlice`: список проектов, дерево позиций, версии, агрегаты.
  - `agentSlice`: конфигурации, статус запусков, последние ответы.
  - `syncSlice`: очередь операций, конфликты, статус соединения.
  - `uiSlice`: уведомления, модальные окна, состояние командной палитры.
- **React Query** отвечает за общение с сервером/облаком, кэширование и актуализацию данных, когда подключение доступно.
- **IndexedDB** (через Dexie + `zustand/persist`) хранит основное содержимое; используется стратегия Write-Behind: изменения сначала записываются в локальную БД, затем попадают в очередь синхронизации.

## Сервис-воркер и офлайн
- Генерация через Workbox CLI.
- Стратегии кэширования:
  - `StaleWhileRevalidate` для статики и манифеста.
  - `NetworkFirst` для API-запросов с фолбэком на кэшированные ответы.
  - `CacheFirst` для шаблонов документов и справки.
- Background Sync для отложенной отправки очереди `SyncQueue`.
- Уведомление об обновлениях: при новой версии воркера показывается баннер с предложением перезапуска.

## Слой данных и интеграции
- Репозитории (классические сервисы): `EstimateRepository`, `AgentRepository`, `SyncRepository`, `ReportRepository`.
- Подписки на изменения реализуются через RxJS Subjects; UI получает обновления, даже если данные изменились в фоне.
- Миграции IndexedDB версионированы (Dexie). Планы данных документированы в `docs/domain-model.md`.
- Безопасность: конфиденциальные поля шифруются с помощью WebCrypto (AES-GCM), ключи выводятся из пароля пользователя (PBKDF2).

## Сквозные требования
- **Обработка ошибок**: глобальный error boundary + контекстные уведомления, очередь для офлайн-логов в Sentry.
- **Интернационализация**: FormatJS; пакеты переводов кэшируются в IndexedDB; поддержка русского и английского на старте.
- **Доступность**: ARIA-атрибуты, фокус-ловушки, тесты VoiceOver. Размер интерактивных зон ≥ 44px.
- **Темизация**: дизайн-токены в CSS-переменных, переключение светлой/тёмной/контрастной темы.

## Инструменты разработки и тестирования
- ESLint + Prettier + Stylelint (правила адаптированы под TypeScript и Tailwind).
- Storybook с мобильными вьюпортами iPhone 15, интеграция с Figma-токенами.
- MSW для имитации API и ответов GenKit.
- Playwright Component + E2E с мобильной эмуляцией, Lighthouse для аудитов PWA и производительности.

## Особенности для iPhone 15 (Safari PWA)
- Добавляются `apple-mobile-web-app-capable`, `apple-touch-icon`, `maskable icons` и splash-экраны соответствующих размеров.
- Учитываем ограничения Safari: отсутствует полноценный push, ограниченный Background Sync. При отсутствии системных уведомлений — используем локальные баннеры и бейджи.
- Тестируем плавность скролла и жестов (swipe actions, pull-to-refresh) на реальном устройстве; оптимизируем рендеринг списков через виртуализацию (React Window).
- Контролируем размер IndexedDB (< 1 ГБ): реализуем очистку старых версий, архивов и больших вложений, а также компрессию.
