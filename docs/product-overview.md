# QuickEstimate Builder — Обзор продукта и требования

## 1. Визия и позиционирование
QuickEstimate Builder — это мобильный PWA-комбайн для подрядчиков, инженеров и сметчиков, который позволяет создавать, анализировать и актуализировать строительные сметы в движении. Ключевой фокус — работа на iPhone 15 и других мобильных устройствах без необходимости устанавливать нативные приложения. Продукт сочетает офлайн-возможности, богатый UX и интеграцию с ИИ (Gemini через GenKit), чтобы ускорить подготовку и актуализацию смет в условиях динамичных цен.

### Ценности для пользователя
- **Скорость**: минимизация времени от запроса клиента до готовой сметы.
- **Точность**: регулярные обновления цен с помощью ИИ и поставщиков.
- **Автономность**: работа без постоянного подключения к сети, синхронизация при появлении интернета.
- **Расширяемость**: настройка собственных ИИ-агентов и интеграция с внешними источниками.

## 2. Целевая аудитория и сценарии
### Целевая аудитория
- Частные подрядчики и малые строительные компании.
- Проектировщики и инженеры, которые ведут сметы для нескольких проектов одновременно.
- Менеджеры проектов, контролирующие бюджеты и отчётность.

### Ключевые сценарии
1. Создание новой сметы с нуля или на основе шаблона/исторических данных.
2. Актуализация позиций сметы по текущим рыночным ценам или предложениям поставщиков.
3. Сравнение смет и подготовка отчётов в PDF/XLSX для подрядчиков и заказчиков.
4. Запуск ИИ-агентов, которые анализируют структуру сметы, выделяют риски и предлагают оптимизации.
5. Импорт/экспорт данных, синхронизация с облаком и обмен сметами внутри команды.

## 3. Требования к UX/UI
- **Single Page Application** с PWA-манифестом и сервис-воркером.
- **Mobile first**: управление одной рукой, крупные тач-таргеты (≥44px), sticky action bar.
- **Высокая отзывчивость**: автосохранение черновиков, индикаторы синхронизации, работа при нестабильном соединении.
- **Интерактивные визуализации**: иерархическое представление сметы, таймлайны изменений, тегирование.
- **Онбординг**: интерактивный тур, библиотека шаблонов и справочный центр.

Дополнительные детали реализуются через дизайн-систему (`docs/design-system.md`) и архитектурный гайд (`docs/architecture/frontend.md`).

## 4. Архитектурный обзор
### Фронтенд
- Стек: TypeScript + React 18 + Vite (выбран как стартовый вариант). Рассматриваемые альтернативы — Vue 3 или SvelteKit.
- Управление состоянием: Zustand + React Query; офлайн-хранилище — IndexedDB (Dexie/LocalForage).
- PWA: Workbox, кастомный сервис-воркер, поддержка Background Sync, корректный манифест для iOS (maskable icons, splash screen).
- Интеграция GenKit SDK для общения с Gemini и запуском агентов.
- Модульная архитектура «feature-sliced» (`src/features/*`) для масштабируемости и тестируемости.

### Бэкенд (опционально)
- Node.js (NestJS/Express) или Supabase/Firebase в качестве управляемого сервиса.
- REST/GraphQL API для проектов, позиций, агентов, версий, синхронизации.
- Очереди и webhook’и для обновления цен и генерации отчётов.
- Возможность полного локального режима без сервера.

### ИИ-слой
- Конфигурация ключей и секретов в защищённом хранилище (WebCrypto + SecureStorage).
- Абстракции «агент» и «флоу» описаны в `docs/ai-module.md`.
- Возможность создавать кастомных агентов, комбинировать инструменты (API поставщиков, парсинг CSV, генерация документов).

## 5. Устойчивость PWA на iPhone 15 (Safari)
- Использование `apple-mobile-web-app-capable`, `apple-touch-icon`, `maskable`-иконок и `display: standalone`.
- Обход ограничений Background Sync: ручные триггеры синхронизации, отслеживание `navigator.onLine`, уведомления о статусе.
- Контроль объёма IndexedDB (<1 ГБ): lazy загрузка, очистка кешей, компрессия вложений.
- Тестирование touch-gestures, haptic feedback (через Web API), производительности (цель — 60fps).
- Обработка обновлений сервис-воркера: уведомлять о новой версии, обеспечивать сохранение черновиков перед перезагрузкой.

## 6. Зависимости
- Доступ к Gemini через GenKit (ключи, квоты, политика использования).
- Выбор UI-библиотеки (Tailwind, Chakra, или кастомные токены из `docs/design-system.md`).
- Источники данных для цен (API поставщиков, CSV, ручной ввод, будущие интеграции с ERP).
- Сторонние сервисы: PDFMake/React-PDF, SheetJS, Sentry/PostHog, Mock Service Worker.
- Решение по бэкенду и инфраструктуре (Supabase, собственный NestJS API, облачный хостинг).

## 7. Риски
- Ограничения PWA на iOS (фоновые задачи, push-уведомления) → предусмотреть альтернативные UX-паттерны.
- Точность данных от поставщиков и управление конфликтами → валидации, история изменений, ручные подтверждения.
- Безопасность офлайн-хранения (секреты, коммерческие данные) → шифрование, контроль доступа, аудит.
- Зависимость от квот и стоимости Gemini → кэширование, оптимизация промптов, мониторинг токенов.
- Масштабируемость UX при больших сметах → виртуализация списков, эффективная пагинация, группировка.

## 8. Инструменты тестирования
- **Unit-тесты**: Vitest/Jest + Testing Library, snapshot для компонентов.
- **Интеграционные тесты**: Playwright Component Testing, Mock Service Worker для подмены API/GenKit.
- **E2E**: Playwright с профилем iPhone 15, Cypress (опционально) для regression suite.
- **UX-исследования**: Maze/UserTesting, аналитика событий (PostHog), heatmaps.
- **Нагрузочное тестирование ИИ**: сценарии с имитацией массового запуска агентов, троттлинг квот.
- **PWA-аудит**: Lighthouse, WebPageTest, iOS-specific smoke-тесты (Safari, Chrome, Standalone).

## 9. Открытые вопросы
1. Нужен ли много-пользовательский режим на старте или достаточно single-user?
2. Какие конкретные поставщики и форматы данных необходимо поддержать в первой итерации?
3. Требуется ли интеграция с бухгалтерским ПО (1С, QuickBooks) для экспорта данных?
4. Какой объем исторических данных планируется импортировать при внедрении?
5. Планируется ли монетизация (подписка, pay-per-use) и какие ограничения нужно заложить в архитектуру?

## 10. Связанные документы
- `docs/architecture/frontend.md` — детальная архитектура SPA/PWA.
- `docs/domain-model.md` — доменная модель и правила валидации.
- `docs/api-contract.md` — структура API и синхронизации.
- `docs/ai-module.md` — дизайн модуля ИИ-агентов и FlowEngine.
- `docs/design-system.md` — визуальный гайд и дизайн-токены.
- `docs/roadmap.md` — поэтапный план реализации и критерии готовности.

Документ служит входной точкой для команды фуллстек-разработчиков и дизайнеров, описывая ключевые ожидания и ограничения проекта QuickEstimate Builder. При обновлении требований данный файл должен синхронизироваться с остальными спецификациями.
