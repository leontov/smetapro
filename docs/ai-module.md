# Спецификация модуля ИИ-агентов

## Цели
Создать модуль, позволяющий конфигурировать, запускать и мониторить ИИ-флоу, которые помогают в расчёте смет, при этом гарантируя прозрачность, контроль и возможность аудита.

## Архитектурные компоненты
- **AgentRegistry**
  - Хранит `AgentConfig` в IndexedDB, ведёт версионность и историю изменений.
  - Обеспечивает CRUD-операции, события для UI и синхронизацию с бэкендом.
- **FlowEngine**
  - Выполняет последовательность шагов `AgentFlowStep` (prompt/tool/transform/decision).
  - Поддерживает ветвления, циклы и стриминг промежуточных результатов через async-генераторы.
  - Управляет тайм-аутами и повторными попытками.
- **ContextBuilder**
  - Собирает данные: выбранная смета, исторические цены, каталоги поставщиков, пользовательские заметки.
  - Фильтрует данные по разрешениям, удаляет PII перед отправкой в Gemini.
- **ExecutionLogService**
  - Записывает `AgentSession`, токены, время, стоимость, вывод шагов.
  - Предоставляет поиск/фильтрацию, экспорт логов (JSON/CSV) и метрики.
- **GenKitConnector**
  - Обёртка над GenKit SDK с единой обработкой ошибок, бэкофами и трейсингом.
  - Имеет режим «песочницы» с мок-ответами для тестов и демо.

## Типы данных (TypeScript)
```ts
type AgentConfig = {
  id: string;
  name: string;
  category: 'Analysis' | 'Update' | 'Report' | 'Custom';
  description: string;
  promptTemplate: PromptBlock[];
  flow: AgentFlowStep[];
  dataBindings: DataBinding[];
  model: string;
  temperature: number;
  topK?: number;
  maxTokens?: number;
  outputFormat: 'Markdown' | 'JSON' | 'CSV' | { mimeType: string };
  permissions: PermissionScope;
  schedule?: ScheduleConfig;
  createdAt: string;
  updatedAt: string;
};

type AgentFlowStep = PromptStep | ToolStep | TransformStep | DecisionStep;

type PromptStep = {
  kind: 'prompt';
  id: string;
  promptBlockId: string;
  stopSignals?: string[];
};

type ToolStep = {
  kind: 'tool';
  id: string;
  toolId: string;
  inputMapping: MappingExpression;
};

type TransformStep = {
  kind: 'transform';
  id: string;
  transformer: 'summarize' | 'diff' | 'price-adjust' | 'custom';
  config: Record<string, unknown>;
};

type DecisionStep = {
  kind: 'decision';
  id: string;
  condition: ConditionExpression;
  onTrue: string;
  onFalse: string;
};

type FlowResult = {
  sessionId: string;
  status: 'success' | 'failure' | 'requires-action';
  outputs: FlowOutput[];
  metrics: {
    totalTokens: number;
    completionTokens: number;
    latencyMs: number;
    costEstimate: number;
  };
  logs: FlowLogEntry[];
};
```

## Жизненный цикл выполнения
1. **Инициализация**: пользователь выбирает агента и смету, `ContextBuilder` собирает `AgentContext`.
2. **Валидация**: `FlowEngine` проверяет корректность графа (цикл, обязательные данные, права).
3. **Запуск**:
   - Создаётся запись `AgentSession` со статусом `Pending`.
   - Для каждого шага:
     - `PromptStep` → запрос к GenKit/Gemini.
     - `ToolStep` → вызов зарегистрированного инструмента (API поставщика, SheetJS и т. п.).
     - `TransformStep` → локальные преобразования (нормализация цен, генерация Markdown → JSON).
     - `DecisionStep` → проверка условия, выбор следующего шага.
   - Результаты стримятся в UI, чтобы пользователь видел прогресс.
4. **Завершение**: статус обновляется, результаты сохраняются, создаются уведомления и задачи синхронизации.
5. **Обработка ошибок**: классификация (`ValidationError`, `RateLimitError`, `NetworkError`, `ModelError`), предложены варианты восстановления (повтор, fallback, ручное действие).

## Инструменты и расширения
- **Tool Registry**: плагины регистрируются с описанием, требуемыми правами и ограничениями. Запуск инструментов — в воркерах/веб-воркерах.
- **Ценовые коннекторы**: API поставщиков, парсер CSV/Excel, веб-скрейперы (через серверные функции).
- **Генераторы отчётов**: обёртки над PDFMake/SheetJS, которые могут использовать результаты агентов.
- **Автоматизация**: планировщик запуска по расписанию, триггеры на события (обновление прайса, изменение статуса сметы).

## UI-точки
- Галерея агентов: карточки с показателями (успехи, средняя стоимость, последний запуск).
- Мастер настройки: пошаговый процесс (цель → контекст → промпт → проверка → публикация) с предпросмотром результата.
- Просмотр сессии: таймлайн шагов, журнал запросов/ответов, кнопки повторного запуска и экспорта.
- Песочница: быстрые эксперименты без сохранения в каталог.

## Безопасность и комплаенс
- Шифрование конфигураций и ключей через WebCrypto.
- Политика ретенции: чувствительные данные в логах автоматически обрезаются через 30 дней.
- Ограничение стоимости: дневные лимиты, предупреждения при превышении.
- Соблюдение политики Gemini: фильтры на запрещённый контент, пользовательское подтверждение перед отправкой больших массивов данных.

## Тестирование
- Юнит-тесты: проверка обработки графа, темплейтов, ветвлений.
- Интеграционные тесты: мок GenKit, симуляция ошибок сети/лимитов.
- Нагрузочные тесты: параллельные запуски, измерение времени и очередей.
- UX-тесты: мобильный сценарий настройки агента, анализ понятности текстов.

## Мониторинг и аналитика
- Инструментирование через OpenTelemetry → отправка в выбранный бекенд (например, Grafana Tempo).
- Метрики: длительность, количество токенов, успех/ошибка, популярные инструменты.
- Алерты при росте ошибок > 5% или задержке > 30 секунд.

## Дорожная карта развития
1. Совместные агенты для команд (общие библиотеки шаблонов, доступы уровня организации).
2. Поддержка мультимодальных входов (фото обмеров, чертежи) по мере появления в Gemini.
3. Обучение на обратной связи пользователей: рейтинг ответов, автоматическая корректировка промптов.
