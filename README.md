# smetapro
Программа для составления смет

## Интеграция с GenKit SDK

### Архитектура интеграции

Интеграция строится вокруг трех ключевых компонентов:

1. **Клиент GenKit** – обертка над официальным SDK, предоставляющая унифицированный интерфейс для вызова моделей генерации контента и вспомогательных сервисов (векторный поиск, обработка запросов). Клиент реализует:
   - управление подключениями и пулом HTTP/gRPC-сеансов;
   - нормализацию входных данных (валидацию схем, локализацию, обогащение метаданными проектов);
   - трассировку вызовов (логирование, метрики Prometheus/OpenTelemetry);
   - адаптацию формата ответов GenKit к доменной модели сметных расчетов.

2. **Адаптер приложений** – слой, переводящий доменные события сметапро (создание смет, генерация шаблонов, анализ отклонений) в запросы к GenKit. Адаптер содержит бизнес-правила маршрутизации (выбор моделей, настройка параметров генерации) и декораторы безопасности (анонимизация данных перед отправкой, фильтрация чувствительной информации).

3. **Менеджер ключей** – сервис, который выдает клиенту временные токены доступа к GenKit и хранит историю операций с ключами. Внутри платформы менеджер интегрирован с секрет-хранилищем и системами IAM, чтобы гарантировать минимально необходимый доступ.

Взаимодействие:

```
Сервисы сметапро → Адаптер → Клиент GenKit → GenKit SDK/API
                       ↓                  ↑
                 Менеджер ключей ← Секрет-менеджер
```

### Управление ключами

Процессы жизненного цикла ключей доступа к GenKit:

- **Создание** – инициируется при онбординге проекта или ротации. Запрос генерируется через сервисный аккаунт в IAM, ключ сохраняется в секрет-менеджере, а менеджер ключей создает запись аудита (кто, когда, для какого окружения).
- **Ротация** – выполняется автоматически каждые 30 дней либо при инцидентах безопасности. Менеджер ключей создает новый ключ, обновляет конфигурацию клиента, запускает smoke-тесты, затем деактивирует старый ключ с задержкой в 24 часа.
- **Аудит** – все обращения к GenKit подписываются идентификатором ключа. Логи попадают в централизованный аудит (ELK/Cloud Logging). Плановые проверки сравнивают набор активных ключей с инвентаризацией сервисов.

В качестве секрет-хранилища используется **HashiCorp Vault** (при on-premise) или **GCP Secret Manager** (в облаке). Менеджер ключей взаимодействует с ними через короткоживущие токены. Клиентам никогда не передаются исходные секреты; выдаются подписанные JWT с ограничением времени жизни и разрешений.

### Политика обработки ошибок и fallback-сценарии

Типы ошибок GenKit:

- **Ошибки валидации (ValidationError)** – неверный формат запроса, неподдерживаемые параметры. Обрабатываются адаптером: возвращается сообщение об ошибке пользователю, проводится запись в журнал качества данных. Автоматический fallback не применяется; требуется исправление данных.
- **Ошибки квот/лимитов (QuotaExceeded, RateLimit)** – исчерпаны лимиты использования. Адаптер переключает трафик на резервный кластер GenKit или уменьшает частоту запросов с помощью экспоненциального backoff. Пользователю показывается уведомление о задержке.
- **Ошибки инфраструктуры (ServiceUnavailable, Timeout)** – проблемы в сети или сервисе GenKit. Клиент выполняет до трех повторных попыток с джиттером. При полном отказе запускается fallback: локальный кэш ответов (если применимо) или альтернативные правила расчета без AI.
- **Ошибки аутентификации (Unauthorized, Forbidden)** – протухший токен или отзыв ключа. Клиент запрашивает новый токен у менеджера ключей и повторяет запрос. При системных сбоях генерируется инцидент с высоким приоритетом.

Все ошибки классифицируются, логируются и маркируются корелляционным ID. Для критичных ошибок в PagerDuty/Slack отправляется уведомление. Пользовательский интерфейс получает унифицированные коды ошибок, чтобы показывать локализованные сообщения.

### Стратегия тестирования

1. **Mock-режим** – клиент GenKit может работать в режиме симуляции: ответы берутся из фикстур, а адаптер проверяет корректность формирования запросов. Используется в unit-тестах и для локальной разработки.
2. **Интеграционные тесты** – в CI поднимается стенд с тестовым проектом GenKit. Сценарии проверяют: создание сметы, генерацию пояснений, обработку ошибок квот и таймаутов, а также корректность логирования. Ключи для тестов хранятся в отдельном пространстве секретов с коротким TTL.
3. **Покрытие в CI** – пайплайн GitHub Actions/GitLab CI включает линтеры, unit-тесты с mock-режимом, интеграционные тесты (по расписанию или по тегу). Метрики покрытия (например, pytest-cov или go test -cover) публикуются в качестве артефактов. При падении тестов автоматика блокирует деплой.

Дополнительно рекомендуется периодически проводить хаос-тестирование (симуляция отказов GenKit, истечения ключей, сетевых сбоев), чтобы проверить надежность fallback-сценариев и процессов ротации ключей.
